<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--  이 공간에 있는 쿼리문들을 호출할 때 이름의 시작 -->
<mapper namespace="noticeboard">

	<!-- 쿼리문 작성 -->
	<select id="noticelist" resultType="noticeboard">
		select aboardNo, clubId, memberId, title, TO_CHAR(aboardDate, 'YYYY-MM-DD') aboardDate , aboardVal, likeCnt, aboardHit from aboard order by aboardNo asc
	</select>
	
	<insert id="editwrite" parameterType="noticeboard">
 		<selectKey resultType="int" keyProperty="aboardNo" order="BEFORE">
			select seq_aboardNo.nextval from dual
		</selectKey>
		insert into aboard(aboardNo, clubId, memberId, aboardVal, title, aboardDate, boardContent )
		values(#{aboardNo}, #{clubId}, #{memberId}, #{aboardVal}, #{title}, SYSDATE, #{boardContent})
	</insert>

	<select id="editlist" parameterType="noticeboard" resultType="noticeboard">
		select a.aboardNo, c.clubId, m.memberId, a.aboardVal, a.title, TO_CHAR(aboardDate, 'YYYY-MM-DD') aboardDate, a.boardContent, aboardHit,
		v.aboardNo, v.voteNo, v.voteTitle, v.vote1, v.vote2, v.vote3, v.vote4, v.vote5, v.totalNum, v.finDate
		from aboard a, club c, member m, avote v
		where a.clubId = c.clubId and a.memberId = m.memberId and a.aboardNo = v.aboardNo and a.aboardNo = #{aboardNo}
	</select>
	
	<select id="voteresult" resultType="com.firmeet.vo.VoteResultVO" parameterType="com.firmeet.vo.VoteResultVO">
		select
			 sum(case when choice = 1 then 1 else 0 end) as vote1cnt
			,sum(case when choice = 2 then 1 else 0 end) as vote2cnt
			,sum(case when choice = 3 then 1 else 0 end) as vote3cnt
			,sum(case when choice = 4 then 1 else 0 end) as vote4cnt
			,sum(case when choice = 5 then 1 else 0 end) as vote5cnt
		from voteResult
		where voteNo = #{voteNo}
	</select>
	
	<insert id="editwritevote" parameterType="noticeboard">
	 	<selectKey resultType="int" keyProperty="voteNo" order="BEFORE">
			select seq_voteNo.nextval from dual
		</selectKey>
		insert into aVote(voteNo, aboardNo, voteTitle, vote1, vote2, vote3, vote4, vote5, totalNum, finDate)
		values(seq_voteNo.nextval, #{aboardNo}, #{voteTitle}, #{vote1}, #{vote2}, #{vote3}, #{vote4}, #{vote5}, #{totalNum}, #{finDate}) 
	</insert>
	
	<insert id="voteinsert" parameterType="noticeboard">
		insert into voteResult(voteResult, voteNo, memberId, choice, voteDate)
		values(seq_voteResultNo.nextval, #{voteNo}, #{memberId}, #{choice}, SYSDATE)
	</insert>
	
	<insert id="editgroupwrite" parameterType="noticeboard">
	 	<selectKey resultType="int" keyProperty="meetNo" order="BEFORE">
			select seq_meetNo.nextval from dual
		</selectKey>
		insert into meet_name(meetNo, aboardNo, clubId, meetYear, meetMon, meetName, startDate, endDate, meetTime, meetPlace, voteEnd, minPerson, maxPerson, price, address1, address2 )
		values(seq_meetNo.nextval, #{aboardNo}, #{clubId}, #{meetYear}, #{meetMon}, #{meetName}, SYSDATE, SYSDATE, #{meetTime}, #{meetPlace}, SYSDATE, #{minPerson}, #{maxPerson}, #{price}, #{address1}, #{address2}) 
	</insert>
	
	<select id="editlistgroup" parameterType="noticeboard" resultType="noticeboard">
		select a.aboardNo, c.clubId, m.memberId, a.aboardVal, a.title, TO_CHAR(aboardDate, 'YYYY-MM-DD') aboardDate, a.boardContent, aboardHit,
		mn.aboardNo, mn.meetNo, mn.clubId, mn.meetYear, mn.meetMon, mn.meetName, TO_CHAR(startDate, 'YYYY-MM-DD') startDate, TO_CHAR(endDate, 'YYYY-MM-DD') endDate, mn.meetTime, mn.meetPlace, mn.voteEnd, mn.minPerson, mn.maxPerson, mn.price, mn.address1, mn.address2
		from aboard a, club c, member m, meet_name mn
		where a.clubId = c.clubId and a.memberId = m.memberId and a.aboardNo = mn.aboardNo and a.aboardNo = #{aboardNo}
	</select>
	
	<update id="hits" parameterType="int">
		update aboard set aboardHit = aboardHit +1 where aboardNo = #{aboardNo}
	</update>

	<insert id="payinsert" parameterType="noticeboard">
		insert into PAYRESULT(payresultNo, meetNo, memberId, payvotedate)
		values(SEQ_PAYRESULTNO.nextval, #{meetNo}, #{memberId}, SYSDATE)
	</insert>
	
	<select id="payresult" resultType="noticeboard" parameterType="noticeboard">
	     SELECT
		    a.aboardNo,
		    c.clubId,
		    m.memberId,
		    a.aboardVal,
		    a.title,
		    TO_CHAR(aboardDate, 'YYYY-MM-DD') AS aboardDate,
		    a.boardContent,
		    aboardHit,
		    mn.aboardNo,
		    mn.meetNo,
		    mn.clubId,
		    mn.meetYear,
		    mn.meetMon,
		    mn.meetName,
		    TO_CHAR(startDate, 'YYYY-MM-DD') AS startDate,
		    TO_CHAR(endDate, 'YYYY-MM-DD') AS endDate,
		    mn.meetTime,
		    mn.meetPlace,
		    mn.voteEnd,
		    mn.minPerson,
		    mn.maxPerson,
		    mn.price,
		    mn.address1,
		    mn.address2,
		    pr.payresultNo,
		    pr.meetNo,
		    pr.memberId,
		    pr.payvotedate,
		    pr.paycount
		    
		FROM
		    aboard a, club c, member m, meet_name mn, payresult pr
		where
		    a.clubId = c.clubId
		and
		    a.memberId = m.memberId
		and
		    a.aboardNo = mn.aboardNo
		and
		    mn.meetNo = pr.meetNo AND m.memberId = pr.memberId
		and
		    pr.payresultNo = #{payresultNo}
		AND
		    (
		        pr.paycount le 1 and
		        pr.memberId eq #{memberId}
		    )
	 </select>

	<update id="paycount" parameterType="noticeboard">
		update PAYRESULT set paycount = paycount +1 where memberId eq #{memberId} and payresultNo eq #{payresultNo}
	</update>
</mapper>
