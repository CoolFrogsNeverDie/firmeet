<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--  이 공간에 있는 쿼리문들을 호출할 때 이름의 시작 -->
<mapper namespace="noticeboard">

	<!-- 쿼리문 작성 -->
	<select id="noticelist" resultType="noticeboard">
		select aboardNo, clubId, memberId, boardContent, title, TO_CHAR(aboardDate, 'YYYY-MM-DD') aboardDate , 
		aboardVal, likeCnt, aboardHit
		from aboard 
		WHERE memberId LIKE '%' || #{keyword} || '%' 
	       	OR boardContent LIKE '%' || #{keyword} || '%'
	       	OR title LIKE '%' || #{keyword} || '%'
		order by aboardNo desc
	</select>

	<insert id="editwrite" parameterType="noticeboard">
 		<selectKey resultType="int" keyProperty="aboardNo" order="BEFORE">
			select seq_aboardNo.nextval from dual
		</selectKey>
		insert into aboard(aboardNo, clubId, memberId, aboardVal, title, aboardDate, boardContent )
		values(#{aboardNo}, #{clubId}, #{memberId}, #{aboardVal}, #{title}, SYSDATE, #{boardContent})
	</insert>

	<select id="editlist" parameterType="noticeboard" resultType="noticeboard">
		select 
			a.aboardNo
			, c.clubId
			, m.memberId
			, a.aboardVal
			, a.title
			, TO_CHAR(aboardDate, 'YYYY-MM-DD') aboardDate, 
			a.boardContent
			, aboardHit
			,v.aboardNo
			, v.voteNo, v.voteTitle, v.vote1, v.vote2, v.vote3, v.vote4, v.vote5, v.totalNum, v.finDate
		from aboard a, club c, member m, avote v
		where a.clubId = c.clubId and a.memberId = m.memberId and a.aboardNo = v.aboardNo and a.aboardNo = #{aboardNo}
	</select>
	
	<insert id="editwritevote" parameterType="noticeboard">
	 	<selectKey resultType="int" keyProperty="voteNo" order="BEFORE">
			select seq_voteNo.nextval from dual
		</selectKey>
		insert into aVote(voteNo, aboardNo, voteTitle, vote1, vote2, vote3, vote4, vote5, totalNum, finDate)
		values(#{voteNo}, #{aboardNo}, #{voteTitle}, #{vote1}, #{vote2}, #{vote3}, #{vote4}, #{vote5}, #{totalNum}, #{finDate}) 
	</insert>
	
	<insert id="voteinsert" parameterType="noticeboard">
		insert into voteResult(voteResult, voteNo, memberId, choice, voteDate)
		values(seq_voteResultNo.nextval, #{voteNo}, #{memberId}, #{choice}, SYSDATE)
	</insert>
	
	<select id="voteresult" resultType="com.firmeet.vo.VoteResultVO" parameterType="com.firmeet.vo.VoteResultVO">
		select
			 sum(case when choice = 1 then 1 else 0 end) as vote1cnt
			,sum(case when choice = 2 then 1 else 0 end) as vote2cnt
			,sum(case when choice = 3 then 1 else 0 end) as vote3cnt
			,sum(case when choice = 4 then 1 else 0 end) as vote4cnt
			,sum(case when choice = 5 then 1 else 0 end) as vote5cnt
		from voteResult
		where voteNo = #{voteNo}
	</select>
	
	<insert id="editgroupwrite" parameterType="noticeboard">
	 	<selectKey resultType="int" keyProperty="meetNo" order="BEFORE">
			select seq_meetNo.nextval from dual
		</selectKey>
		insert into meet_name(meetNo, aboardNo, clubId, meetYear, meetMon, meetName, startDate, endDate, meetTime, meetPlace, voteEnd, minPerson, maxPerson, price, address1, address2 )
		values(#{meetNo}, #{aboardNo}, #{clubId}, #{meetYear}, #{meetMon}, #{meetName}, SYSDATE, SYSDATE, #{meetTime}, #{meetPlace}, SYSDATE, #{minPerson}, #{maxPerson}, #{price}, #{address1}, #{address2}) 
	</insert>
	
	<select id="editlistgroup" parameterType="noticeboard" resultType="noticeboard">
		select a.aboardNo, c.clubId, m.memberId, a.aboardVal, a.title, TO_CHAR(aboardDate, 'YYYY-MM-DD') aboardDate, a.boardContent, aboardHit,
		mn.aboardNo, mn.meetNo, mn.clubId, mn.meetYear, mn.meetMon, mn.meetName, TO_CHAR(startDate, 'YYYY-MM-DD') startDate, TO_CHAR(endDate, 'YYYY-MM-DD') endDate, mn.meetTime, mn.meetPlace, mn.voteEnd, mn.minPerson, mn.maxPerson, mn.price, mn.address1, mn.address2
		from aboard a, club c, member m, meet_name mn
		where a.clubId = c.clubId and a.memberId = m.memberId and a.aboardNo = mn.aboardNo and a.aboardNo = #{aboardNo}
	</select>
	
	<update id="hits" parameterType="int">
		update aboard set aboardHit = aboardHit +1 where aboardNo = #{aboardNo}
	</update>
	
 	<select id = "getComment" parameterType ="noticeboard" resultType ="areply">
		<![CDATA[
    		SELECT
       			replyno as replyNo
       			,stat
       			,a.memberId as memberId 
        		,memberName as memberName
        		,replycontent as replyContent
        		,TO_CHAR(replyDate, 'YYYY-MM-DD') as replyDate
       			,REPLYGROUP as replyGroup
        		,deep
   			from areply a join member b on a.memberId = b.memberId
    		where aboardNo = #{aboardNo}
   			order by replygroup , deep , replyNo
		]]>
	</select>
	
	
	<delete id = "deletelike" parameterType = "noticeboard">
		<![CDATA[
			delete aboard_like 
			where likeno = #{likeNo}
		]]>
	</delete>
	
	<insert id = "insertLike" parameterType = "noticeboard">
		<selectKey keyProperty = "likeNo" resultType ="int" order ="BEFORE">
			select SEQ_ABOARD_LIKENO.nextval from dual
		</selectKey>
			<![CDATA[
	            insert into aboard_like(
	            	LIKENO
	            	,ABOARDNO
	            	,MEMBERID
	            	,LIKEDATE
	            	)
	            values (
	              #{likeNo}
	            , #{aboardNo}
	            , #{memberId}
	            ,sysdate
	            )
			]]>
	</insert>
	
	<select id = "getLike" parameterType = "noticeboard" resultType = "noticeboard">
		<![CDATA[
			select
				likeNo
				,aboardNo
			from aboard_like
			where likeNo = #{likeNo}				
		]]>
	</select>
</mapper>